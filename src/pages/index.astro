---
import Layout from '../layouts/Layout.astro';
import Courses from '../components/Courses.astro';
import Professors from '~/components/Professors.astro';
import Header from '../components/Header.astro';
import UniversityCard from '~/components/UniversityCard.astro';
import UniversitySearch from '~/components/UniversitySearch.astro';
import { supabaseServer } from '../lib/supabase';

const { data, error } = await supabaseServer
    .from('universities')
    .select(`
        id,
        name,
        slug,
        courses (
            id,
            reviews (
                rating
            ),
            professor_course_campus (
                professors (
                    id,
                    department
                )
            )
        )
    `)
    .order('name', { ascending: true });

if (error) {
    console.error('Error de Supabase:', error.message);
}

const universitiesStats = (data || []).map((u: any) => {
    const courses = u.courses || [];
    const all_reviews = courses.flatMap((c: any) => c.reviews || []);
    const review_count = all_reviews.length;

    const total_rating = all_reviews.reduce((sum: number, r: any) => sum + (r?.rating ?? 0), 0);
    const avg_rating = review_count > 0 ? total_rating / review_count : 0;

    const all_professors = courses.flatMap((c: any) =>
        (c.professor_course_campus || []).flatMap((pcc: any) => {
            const profs = pcc?.professors;
            if (!profs) return [];
            return Array.isArray(profs) ? profs : [profs];
        })
    );

    const unique_professors = new Set(all_professors.filter(Boolean).map((p: any) => p.id));
    const unique_departments = new Set(
        all_professors
            .filter((p: any) => p && p.department)
            .map((p: any) => p.department.trim().toLowerCase())
    );

    return {
        name: u.name,
        slug: u.slug,
        avg_rating,
        review_count,
        professor_count: unique_professors.size,
        department_count: unique_departments.size,
    };
});

const universities = universitiesStats;

---

<Layout>
	<body>
		<div class="min-h-screen w-full bg-gradient-to-br from-indigo-50 via-blue-50 to-slate-50">
			{/*Main Content*/}
			<main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
				{/*Title*/}
				<div class="text-center mb-12">
					<h2 class="text-4xl font-bold text-gray-900 mb-3">
						Selecciona Tu Universidad
					</h2>
					<p class="text-lg text-gray-600">
						Escoge tu universidad para ver los profesores calificados.
					</p>
				</div>
				{/*Search Bar*/}
				<UniversitySearch />

				{/*College Cards Grid*/}
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
				{universities.map((uni: any) => (
					<UniversityCard 
					name={uni.name}
					slug={uni.slug}
					location="Monterrey, NL" 
					avgRating={uni.avg_rating}         
					professorCount={uni.professor_count}    
					reviewCount={uni.review_count}       
					departmentCount={uni.department_count}     
					/>
				))}
				</div>
			</main>
		</div>
	</body>
</Layout>
