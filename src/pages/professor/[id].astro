---
import { supabaseServer } from "~/lib/supabase";
import Layout from "../../layouts/Layout.astro";
import BackButton from "~/components/BackButton.astro";
import ReviewForm from "~/components/ReviewForm.astro";
const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/404');
}

const { data: professor, error } = await supabaseServer
        .from('professors')
        .select('*, universities(slug)')
        .eq('id', id)
        .single();

if (error || !professor) {
        return Astro.redirect('/404');
}

const universitySlug = professor.universities?.slug;
---

<Layout>
    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <BackButton 
            text="Volver a la Universidad" 
            href={`/university/${universitySlug}`} 
        />
            <h1 class="text-3xl font-bold mb-6">Professor Details - ID: {id}</h1>

                        <details class="mb-6">
                                <summary onclick="handleOpenReview(event)" class="cursor-pointer inline-block px-3 py-2 bg-purple-600 text-white rounded-md">AÃ±adir review</summary>
                                <div class="mt-4">
                                        <ReviewForm professorId={id} />
                                </div>
                        </details>
    </main>
</Layout>

<script>
    function hasAuthCookies() {
        return document.cookie.includes('sb-access-token=') && document.cookie.includes('sb-refresh-token=');
    }

    function handleOpenReview(event: { preventDefault: () => void; }) {
        if (!hasAuthCookies()) {
            event.preventDefault();
            // redirect to signin so user can authenticate before posting a review
            window.location.href = '/signin';
        }
        // if cookies exist, allow the details element to open and show the form
    }
</script>
