---
import { supabaseServer } from "~/lib/supabase";
import Layout from "../../layouts/Layout.astro";
import BackButton from "~/components/BackButton.astro";
import ReviewForm from "~/components/ReviewForm.astro";
const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/404');
}

const { data: professor, error } = await supabaseServer
    .from('professors')
    .select('*, universities(id, slug)')
    .eq('id', id)
    .single();

if (error || !professor) {
        return Astro.redirect('/404');
}

const universitySlug = professor.universities?.slug;
const universityId = professor.universities?.id;

const { data: courses, error: coursesError } = await supabaseServer
    .from('courses')
    .select('id, name, code')
    .eq('university_id', universityId)
    .order('name', { ascending: true });

const universityCourses = coursesError ? [] : (courses ?? []);

const { data: reviews, error: reviewsError } = await supabaseServer
    .from('reviews')
    .select('id, professor_id, course_id, comment, created_at, difficulty, quality, would_recommend, courses(name, code)')
    .eq('professor_id', id)
    .order('created_at', { ascending: false });

const professorReviews = reviewsError ? [] : (reviews ?? []);
---

<Layout>
    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <BackButton 
            text="Volver a la Universidad" 
            href={`/university/${universitySlug}`} 
        />
            <h1 class="text-3xl font-bold mb-6">Professor Details - ID: {id}</h1>

                        <details class="mb-6">
                                <summary onclick="handleOpenReview(event)" class="cursor-pointer inline-block px-3 py-2 bg-purple-600 text-white rounded-md">Añadir review</summary>
                                <div class="mt-4">
                                        <ReviewForm professorId={id} universityId={universityId} courses={universityCourses} />
                                </div>
                        </details>

                        <section class="mt-8">
                            <h2 class="text-2xl font-semibold mb-4">Reviews</h2>
                            {professorReviews.length === 0 ? (
                                <p class="text-gray-600">Aún no hay reviews para este profesor.</p>
                            ) : (
                                <ul class="space-y-4">
                                    {professorReviews.map((review) => (
                                        <li class="border border-gray-200 rounded-lg p-4" key={review.id}>
                                            <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-2">
                                                <span>
                                                    Curso: {review.courses ? `${review.courses.code} - ${review.courses.name}` : (review.course_id ?? 'N/A')}
                                                </span>
                                                <span>Dificultad: {review.difficulty}</span>
                                                <span>Calidad: {review.quality}</span>
                                                <span>Recomendaría: {review.would_recommend ? 'Sí' : 'No'}</span>
                                                <span>{new Date(review.created_at).toLocaleDateString()}</span>
                                            </div>
                                            <p class="text-gray-800">{review.comment}</p>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </section>
    </main>
</Layout>

<script>
    function hasAuthCookies() {
        return document.cookie.includes('sb-access-token=') && document.cookie.includes('sb-refresh-token=');
    }

    function handleOpenReview(event: { preventDefault: () => void; }) {
        if (!hasAuthCookies()) {
            event.preventDefault();
            // redirect to signin so user can authenticate before posting a review
            window.location.href = '/signin';
        }
        // if cookies exist, allow the details element to open and show the form
    }
</script>
