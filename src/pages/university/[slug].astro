---
import Layout from "../../layouts/Layout.astro";
import BackButton from "../../components/BackButton.astro";
import ProfessorSearch from "../../components/ProfessorSearch.astro";
import ProfessorCard from "../../components/ProfessorCard.astro";
import AddProfessorModal from "~/components/AddProfessorModal.astro";
import { supabaseServer } from "../../lib/supabase";
import { Star, UserPlus } from '@lucide/astro';

const { slug } = Astro.params;

const { data: university, error } = await supabaseServer
  .from("universities")
  .select("id, name, slug")
  .eq("slug", slug)
  .single();

if (error || !university) {
  return Astro.redirect('/404');
}

const { data: professors, error: professorsError } = await supabaseServer
  .from("university_professor_stats")
  .select("id, name, department, avg_rating, avg_difficulty, retake_rate, review_count, matching_courses")
  .eq("university_slug", slug)
  .order("review_count", { ascending: false })
  .order("name", { ascending: true });

if (professorsError) {
  console.error("Error de Supabase:", professorsError.message);
}

const totalProfessors = (professors || []).length;
---

<Layout subtitle={university.name}>
  <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      
      {/* Botón Volver */}
      <div class="mb-6">
        <BackButton text="Ver otras universidades" href="/" />
      </div>

      {/* Título */}
      <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Profesores de {university.name}</h1>
        <p class="text-gray-600">Encuentra y califica a tus profesores</p>
      </div>

      {/* Buscador */}
      <div class="bg-white rounded-2xl border border-gray-200 p-6 mb-8 shadow-sm">
          <ProfessorSearch placeholder="Buscar profesores por nombre, departamento o curso..." />
      </div>

      {/*Results Header */}
      <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">
          Todos los Profesores
        </h2>
        <p id="results-count" class="text-sm text-blue-600 font-medium mt-1">
          {totalProfessors} {totalProfessors === 1 ? 'profesor' : 'profesores'} encontrados
        </p>
      </div>

      {/* Botón Suggest */}
      <button
        id="suggest-btn"
        class="inline-flex items-center px-6 py-2.5 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors cursor-pointer"
      >
        <UserPlus class="w-5 h-5 mr-2" />
        Añadir Profesor
      </button>
    </div>

      {/* CONTENEDOR PRINCIPAL */}
      <div
        id="professors-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        {(professors || []).map((prof: any) => (
            <ProfessorCard 
                id={prof.id}
                name={prof.name} 
                department={prof.department} 
                avg_rating={prof.avg_rating} 
                avg_difficulty={prof.avg_difficulty} 
                retake_rate={prof.retake_rate} 
                review_count={prof.review_count}
                matching_courses={prof.matching_courses} 
            />
        ))}
      </div>

      <div id="no-results-message" class="hidden text-center py-16 bg-white rounded-2xl border-2 border-dashed border-gray-200">
        <Star class="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No se encontraron profesores</h3>
        <p class="text-gray-500 mb-6">
            Intenta ajustar tus criterios de búsqueda o borrar los filtros aplicados.
        </p>
        <button
            id="clear-filters-btn"
            class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors cursor-pointer"
        >
            Borrar filtros
        </button>
      </div>

      {(professors || []).length === 0 && (
         <div class="text-center py-16 bg-white rounded-2xl border-2 border-dashed border-gray-200">
            <p class="text-gray-500 text-lg">Aún no hay datos cargados para esta universidad.</p>
         </div>
      )}

      {/* Suggest Professor Modal */}
      <AddProfessorModal universityId={university.id}/>
  </main>
</Layout>

<script>
  document.addEventListener('search-professors', ((e: CustomEvent) => {
    const query = e.detail.toLowerCase().trim();
    const cards = document.querySelectorAll('.professor-card');
    const noResults = document.getElementById('no-results-message');
    const grid = document.getElementById('professors-grid');
    
    let visibleCount = 0;

    cards.forEach((card) => {
      const element = card as HTMLElement;
      const coursesContainer = element.querySelector('.courses-container');

      const name = element.dataset.name || '';
      const dept = element.dataset.department || '';
      const courses = element.dataset.courses || '';

      const matchesName = name.includes(query);
      const matchesDept = dept.includes(query);
      const matchesCourses = courses.includes(query);

      if (matchesName || matchesDept || matchesCourses) {
        element.style.display = '';
        visibleCount++;

        if (coursesContainer) {
            if (query.length > 0 && matchesCourses) {
                coursesContainer.classList.remove('hidden');
            } else {
                coursesContainer.classList.add('hidden');
            }
        }

      } else {
        element.style.display = 'none';
      }
    });

    const countElement = document.getElementById('results-count');
    if (countElement) {
        const professorText = visibleCount === 1 ? 'profesor' : 'profesores';
        const foundText = visibleCount === 1 ? 'encontrado' : 'encontrados';
        countElement.textContent = `${visibleCount} ${professorText} ${foundText}`;
    }

    if (visibleCount === 0 && cards.length > 0) {
        if(noResults) noResults.classList.remove('hidden');
        if(grid) grid.classList.add('hidden');
    } else {
        if(noResults) noResults.classList.add('hidden');
        if(grid) grid.classList.remove('hidden');
    }

  }) as EventListener);

  const suggestBtn = document.getElementById('suggest-btn');
  const modal = document.getElementById('add-modal');
  if (suggestBtn && modal) {
      suggestBtn.addEventListener('click', () => {
          modal.classList.remove('hidden');
      });
  }

  const clearBtn = document.getElementById('clear-filters-btn');
  if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        const input = document.getElementById('professor-search') as HTMLInputElement;
        if(input) {
            input.value = '';
            input.focus();
        }

        document.dispatchEvent(new CustomEvent('search-professors', { detail: '' }));
      });
  }

</script>