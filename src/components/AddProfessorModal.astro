---
import { UserPlus, X, CircleAlert } from '@lucide/astro';

interface Props {
  universityId: number;
}

const { universityId } = Astro.props;

---

<div 
  id="add-modal" 
  class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300"
  role="dialog"
  aria-modal="true"
>
  <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
    
    {/* Header */}
    <div class="flex items-center justify-between p-6 border-b border-gray-200 shrink-0">
      <div class="flex items-center gap-3">
        <div class="bg-indigo-100 rounded-xl p-2">
          <UserPlus class="w-6 h-6 text-indigo-600" />
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Añadir Profesor</h2>
          <p class="text-sm text-gray-500 mt-1">Ayúdanos a expandir la base de datos</p>
        </div>
      </div>
      <button id="close-modal-btn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer">
        <X class="w-5 h-5 text-gray-500" />
      </button>
    </div>

    {/* Scrollable Content */}
    <div class="overflow-y-auto p-6 space-y-5">
        <form id="add-form" class="space-y-5">
            <input type="hidden" name="university_id" id="university-id-input" value={universityId} />

            {/* Context Note */}
            <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4 flex gap-3">
                <CircleAlert class="w-5 h-5 text-indigo-600 shrink-0 mt-0.5" />
                <p class="text-sm text-indigo-900 font-medium">
                El profesor será visible inmediatamente pero será revisado por moderadores.
                </p>
            </div>

            {/* Full Name */}
            <div>
                <label for="professorName" class="block font-medium text-gray-900 mb-2">Nombre Completo *</label>
                <input
                id="professorName"
                name="name"
                type="text"
                placeholder="Ej. Dr. Juan Pérez"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                required
                />
            </div>

            {/* Department */}
            <div>
                <label for="department" class="block font-medium text-gray-900 mb-2">Departamento *</label>
                <select
                id="department"
                name="department"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white"
                required
                >
              <option value="">Cargando departamentos...</option>
                </select>
            </div>

            <div id="custom-department-field" class="hidden">
              <label for="custom-department" class="block font-medium text-gray-900 mb-2">Agregar departamento *</label>
              <input
              id="custom-department"
              name="custom_department"
              type="text"
              placeholder="Ej. Matemáticas"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>

            {/* Buttons */}
            <div class="flex gap-4 pt-2 pb-2">
                <button
                type="button"
                id="cancel-modal-btn"
                class="flex-1 py-3 px-4 border-2 border-gray-200 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer"
                >
                Cancelar
                </button>
                <button
                type="submit"
                id="submit-btn"
                class="flex-1 py-3 px-4 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                >
                Añadir Profesor
                </button>
            </div>
        </form>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('add-modal');
  const closeBtn = document.getElementById('close-modal-btn');
  const cancelBtn = document.getElementById('cancel-modal-btn');
  const form = document.getElementById('add-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  const universityIdInput = document.getElementById('university-id-input') as HTMLInputElement;
  const departmentSelect = document.getElementById('department') as HTMLSelectElement;
  const customDepartmentField = document.getElementById('custom-department-field') as HTMLDivElement;
  const customDepartmentInput = document.getElementById('custom-department') as HTMLInputElement;
  let departmentsLoaded = false;

  const closeModal = () => {
    if (modal) modal.classList.add('hidden');
    if (form) form.reset();
    if (customDepartmentField) customDepartmentField.classList.add('hidden');
    if (customDepartmentInput) customDepartmentInput.required = false;
  };

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  const renderDepartments = (items: string[]) => {
    if (!departmentSelect) return;
    departmentSelect.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Selecciona un departamento';
    departmentSelect.appendChild(placeholder);

    items.forEach((dept) => {
      const option = document.createElement('option');
      option.value = dept;
      option.textContent = dept;
      departmentSelect.appendChild(option);
    });

    const other = document.createElement('option');
    other.value = 'Agregar';
    other.textContent = 'Agregar';
    departmentSelect.appendChild(other);
  };

  const toggleCustomDepartment = () => {
    if (!departmentSelect || !customDepartmentField || !customDepartmentInput) return;
    if (departmentSelect.value === 'Agregar') {
      customDepartmentField.classList.remove('hidden');
      customDepartmentInput.required = true;
    } else {
      customDepartmentField.classList.add('hidden');
      customDepartmentInput.required = false;
      customDepartmentInput.value = '';
    }
  };

  const loadDepartments = async () => {
    if (departmentsLoaded || !departmentSelect) return;

    try {
      const uniId = universityIdInput.value;
      const res = await fetch(`/api/university-departments?university_id=${encodeURIComponent(uniId)}`);
      if (!res.ok) throw new Error('Failed to load departments');
      const items = await res.json();
      const list = Array.isArray(items) ? items : [];
      renderDepartments(list);
      departmentsLoaded = true;
    } catch (error) {
      console.error('Error cargando departamentos', error);
      renderDepartments([]);
      departmentsLoaded = false;
    }
  };

  const suggestBtn = document.getElementById('suggest-btn');
  suggestBtn?.addEventListener('click', () => {
    loadDepartments();
  });

  departmentSelect?.addEventListener('change', toggleCustomDepartment);

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Enviando...';
    submitBtn.disabled = true;

    const formData = new FormData(form);

    const selectedDepartment = String(formData.get('department') || '').trim();
    const customDepartment = String(formData.get('custom_department') || '').trim();
    const departmentToSend = selectedDepartment === 'Agregar' ? customDepartment : selectedDepartment;

    if (!departmentToSend) {
      alert('Selecciona un departamento o escribe uno nuevo.');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      return;
    }

    const data = {
      name: formData.get('name'),
      department: departmentToSend,
      university_id: formData.get('university_id')
    };

    try {
        const response = await fetch('/api/professors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            alert('¡Gracias! Tu sugerencia ha sido recibida.');
            closeModal();
        } else {
            const errorData = await response.json();
            alert('Error: ' + (errorData.error || 'Algo salió mal'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión.');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
  });
</script>