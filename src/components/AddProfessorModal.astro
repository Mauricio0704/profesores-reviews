---
import { UserPlus, X, CircleAlert, Loader } from '@lucide/astro';

interface Props {
  universityId: number;
}

const { universityId } = Astro.props;

const departments = [
  "Ingeniería y Ciencias",
  "Ciencias de la Salud",
  "Negocios",
  "Humanidades y Educación",
  "Ciencias Sociales",
  "Arquitectura, Arte y Diseño",
  "Otro"
];
---

<div 
  id="add-modal" 
  class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300"
  role="dialog"
  aria-modal="true"
>
  <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
    
    {/* Header */}
    <div class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
      <div class="flex items-center gap-3">
        <div class="bg-indigo-100 rounded-xl p-2">
          <UserPlus class="w-6 h-6 text-indigo-600" />
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Añadir Profesor</h2>
          <p class="text-sm text-gray-500 mt-1">Ayúdanos a expandir la base de datos</p>
        </div>
      </div>
      <button id="close-modal-btn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer">
        <X class="w-5 h-5 text-gray-500" />
      </button>
    </div>

    {/* Scrollable Content */}
    <div class="overflow-y-auto p-6 space-y-5">
        <form id="suggest-form" class="space-y-5">
            <input type="hidden" name="university_id" id="university-id-input" value={universityId} />

            {/* Context Note */}
            <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4 flex gap-3">
                <CircleAlert class="w-5 h-5 text-indigo-600 flex-shrink-0 mt-0.5" />
                <p class="text-sm text-indigo-900 font-medium">
                El profesor será visible inmediatamente pero será revisado por moderadores.
                </p>
            </div>

            {/* Full Name */}
            <div>
                <label for="professorName" class="block font-medium text-gray-900 mb-2">Nombre Completo *</label>
                <input
                id="professorName"
                name="name"
                type="text"
                placeholder="Ej. Dr. Juan Pérez"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                required
                />
            </div>

            {/* Department */}
            <div>
                <label for="department" class="block font-medium text-gray-900 mb-2">Departamento *</label>
                <select
                id="department"
                name="department"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white"
                required
                >
                <option value="">Selecciona un departamento</option>
                {departments.map((dept) => (
                    <option value={dept}>{dept}</option>
                ))}
                </select>
            </div>

            {/* Course Auto-complete Section */}
            <div>
                <label class="block font-medium text-gray-900 mb-2">
                    Curso <span class="text-gray-500 font-normal">(Opcional)</span>
                </label>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    {/* Input Código */}
                    <div class="relative sm:col-span-1">
                        <label for="courseCode" class="block text-sm text-gray-600 mb-1">Código</label>
                        <input
                            id="courseCode"
                            name="course_code"
                            type="text"
                            autocomplete="off"
                            placeholder="Ej. TC1033"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase"
                        />
                        {/* Dropdown Código */}
                        <ul id="code-dropdown" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-48 overflow-y-auto"></ul>
                    </div>

                    {/* Input Nombre */}
                    <div class="relative sm:col-span-2">
                        <label for="courseName" class="block text-sm text-gray-600 mb-1">Nombre</label>
                        <input
                            id="courseName"
                            name="course_name"
                            type="text"
                            autocomplete="off"
                            placeholder="Ej. Pensamiento Computacional"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                        {/* Spinner de carga */}
                        <div id="course-loading" class="hidden absolute right-3 top-[38px]">
                            <Loader class="w-5 h-5 text-indigo-500 animate-spin" />
                        </div>
                        {/* Dropdown Nombre */}
                        <ul id="name-dropdown" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-48 overflow-y-auto"></ul>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    Escribe el código o nombre para buscar cursos existentes.
                </p>
            </div>

            {/* Buttons */}
            <div class="flex gap-4 pt-2 pb-2">
                <button
                type="button"
                id="cancel-modal-btn"
                class="flex-1 py-3 px-4 border-2 border-gray-200 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer"
                >
                Cancelar
                </button>
                <button
                type="submit"
                id="submit-btn"
                class="flex-1 py-3 px-4 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                >
                Añadir Profesor
                </button>
            </div>
        </form>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('suggest-modal');
  const closeBtn = document.getElementById('close-modal-btn');
  const cancelBtn = document.getElementById('cancel-modal-btn');
  const form = document.getElementById('suggest-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  const courseCodeInput = document.getElementById('courseCode') as HTMLInputElement;
  const courseNameInput = document.getElementById('courseName') as HTMLInputElement;
  const codeDropdown = document.getElementById('code-dropdown') as HTMLUListElement;
  const nameDropdown = document.getElementById('name-dropdown') as HTMLUListElement;
  const loadingIndicator = document.getElementById('course-loading');
  const universityIdInput = document.getElementById('university-id-input') as HTMLInputElement;

  const closeModal = () => {
    if (modal) modal.classList.add('hidden');
    if (form) form.reset();
    hideDropdowns();
  };

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  function debounce(func: Function, wait: number) {
    let timeout: any;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function hideDropdowns() {
    codeDropdown.classList.add('hidden');
    nameDropdown.classList.add('hidden');
    codeDropdown.innerHTML = '';
    nameDropdown.innerHTML = '';
  }

  function selectCourse(code: string, name: string) {
    courseCodeInput.value = code;
    courseNameInput.value = name;
    hideDropdowns();
  }

  async function searchCourses(query: string, targetDropdown: HTMLUListElement) {
    if (query.length < 2) {
      hideDropdowns();
      return;
    }

    loadingIndicator?.classList.remove('hidden');

    try {
      const uniId = universityIdInput.value;
      const res = await fetch(`/api/courses/search?q=${encodeURIComponent(query)}&university_id=${uniId}`);
      const courses = await res.json();

      targetDropdown.innerHTML = '';

      if (courses.length > 0) {
        courses.forEach((course: any) => {
          const li = document.createElement('li');
          li.className = 'px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 last:border-0';
          li.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-medium text-gray-900">${course.code}</span>
                <span class="text-sm text-gray-600 truncate ml-4">${course.name}</span>
            </div>
          `;
          
          li.addEventListener('click', () => {
            selectCourse(course.code, course.name);
          });
          
          targetDropdown.appendChild(li);
        });
        targetDropdown.classList.remove('hidden');
      } else {
        targetDropdown.classList.add('hidden');
      }
    } catch (error) {
      console.error("Error buscando cursos", error);
    } finally {
      loadingIndicator?.classList.add('hidden');
    }
  }

  const handleCodeSearch = debounce((e: Event) => {
    const target = e.target as HTMLInputElement;
    searchCourses(target.value, codeDropdown);
  }, 300);

  const handleNameSearch = debounce((e: Event) => {
    const target = e.target as HTMLInputElement;
    searchCourses(target.value, nameDropdown);
  }, 300);

  courseCodeInput?.addEventListener('input', handleCodeSearch);
  courseNameInput?.addEventListener('input', handleNameSearch);

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!courseCodeInput.contains(target) && !codeDropdown.contains(target) && 
        !courseNameInput.contains(target) && !nameDropdown.contains(target)) {
      hideDropdowns();
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Enviando...';
    submitBtn.disabled = true;

    const formData = new FormData(form);

    const data = {
        name: formData.get('name'),
        department: formData.get('department'),
        course_code: formData.get('course_code'),
        course_name: formData.get('course_name'),
        university_id: formData.get('university_id')
    };

    try {
        const response = await fetch('/api/professors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            alert('¡Gracias! Tu sugerencia ha sido recibida.');
            closeModal();
        } else {
            const errorData = await response.json();
            alert('Error: ' + (errorData.error || 'Algo salió mal'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión.');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
  });
</script>